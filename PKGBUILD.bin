# Maintainer: fibsussy <noahlykins@gmail.com>
pkgname=keyboard-middleware
pkgver=0.3.1
pkgrel=1
pkgdesc="QMK-inspired keyboard middleware with home row mods, layers, SOCD, and game mode"
arch=('x86_64' 'aarch64')
url="https://github.com/fibsussy/keyboard-middleware"
license=('MIT')
depends=('systemd' 'udev')
makedepends=()
optdepends=('niri: automatic game mode detection in Niri compositor')
options=('!debug')
install=$pkgname.install

# Download precompiled binary from GitHub releases
_arch="$CARCH"
if [ "$_arch" = "x86_64" ]; then
    _arch="x86_64"
elif [ "$_arch" = "aarch64" ]; then
    _arch="aarch64"
fi

source=(
    "https://github.com/fibsussy/keyboard-middleware/releases/download/v${pkgver}/keyboard-middleware-linux-${_arch}.tar.gz"
    "keyboard-middleware.service::https://raw.githubusercontent.com/fibsussy/keyboard-middleware/v${pkgver}/keyboard-middleware.service"
    "keyboard-middleware-niri.service::https://raw.githubusercontent.com/fibsussy/keyboard-middleware/v${pkgver}/keyboard-middleware-niri.service"
    "config.example.ron::https://raw.githubusercontent.com/fibsussy/keyboard-middleware/v${pkgver}/config.example.ron"
)
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP')  # Update with actual checksums for releases

package() {
    # Install precompiled binary
    install -Dm755 "$srcdir/$pkgname" "$pkgdir/usr/bin/$pkgname"

    # Install systemd system service (runs as root)
    install -Dm644 "$srcdir/$pkgname.service" "$pkgdir/usr/lib/systemd/system/$pkgname.service"

    # Install systemd user service (niri watcher)
    install -Dm644 "$srcdir/$pkgname-niri.service" "$pkgdir/usr/lib/systemd/user/$pkgname-niri.service"

    # Install example config
    install -Dm644 "$srcdir/config.example.ron" "$pkgdir/usr/share/doc/$pkgname/config.example.ron"

    # Generate and install shell completions for main binary
    install -dm755 "$pkgdir/usr/share/bash-completion/completions"
    install -dm755 "$pkgdir/usr/share/zsh/site-functions"
    install -dm755 "$pkgdir/usr/share/fish/vendor_completions.d"

    "$srcdir/$pkgname" completion bash > "$pkgdir/usr/share/bash-completion/completions/$pkgname"
    "$srcdir/$pkgname" completion zsh > "$pkgdir/usr/share/zsh/site-functions/_$pkgname"
    "$srcdir/$pkgname" completion fish > "$pkgdir/usr/share/fish/vendor_completions.d/$pkgname.fish"

    # Create config directory structure in package
    install -dm755 "$pkgdir/etc/skel/.config/$pkgname"
}
