# Maintainer: fibsussy <fibsussy@tuta.io>
pkgname=keymux-git
pkgver=1.0.11
pkgrel=1
pkgdesc="Keyboard middleware for gaming with low-level input interception (git version)"
arch=('x86_64' 'aarch64')
url="https://github.com/fibsussy/keymux"
license=('MIT')
depends=('systemd' 'udev')
makedepends=('rust' 'cargo' 'git')
optdepends=('niri: automatic game mode detection in Niri compositor')
provides=('keymux')
conflicts=('keymux' 'keymux-bin' 'keymux-local')
options=('!debug')
install=keymux.install
source=("git+https://github.com/fibsussy/keymux.git")
sha256sums=('SKIP')

pkgver() {
    cd keymux
    local version=$(grep '^version = ' Cargo.toml | head -n1 | cut -d'"' -f2)
    local commit=$(git rev-parse --short HEAD)
    local date=$(git log -1 --format=%cd --date=format:%Y%m%d)
    echo "$version+r$commit.$date"
}

prepare() {
    cd keymux
    # For git version, we're always building from clean remote clone
    # No need to check for uncommitted changes
}

build() {
    cd keymux
    export RUSTUP_TOOLCHAIN=stable
    export CARGO_TARGET_DIR=target
    cargo build --release --frozen
}

package() {
    cd keymux
    local binary_name="keymux"
    
    install -Dm755 "target/release/$binary_name" "$pkgdir/usr/bin/$binary_name"
    install -Dm644 "$binary_name.service" "$pkgdir/usr/lib/systemd/system/$binary_name.service"
    install -Dm644 "$binary_name-niri.service" "$pkgdir/usr/lib/systemd/user/$binary_name-niri.service"
    install -Dm644 "config.example.ron" "$pkgdir/usr/share/doc/$binary_name/config.example.ron"
    install -Dm644 README.md "$pkgdir/usr/share/doc/$binary_name/README.md"
    
    install -dm755 "$pkgdir/usr/share/bash-completion/completions"
    install -dm755 "$pkgdir/usr/share/zsh/site-functions"
    install -dm755 "$pkgdir/usr/share/fish/vendor_completions.d"
    
    "target/release/$binary_name" completion bash > "$pkgdir/usr/share/bash-completion/completions/$binary_name"
    "target/release/$binary_name" completion zsh > "$pkgdir/usr/share/zsh/site-functions/_$binary_name"
    "target/release/$binary_name" completion fish > "$pkgdir/usr/share/fish/vendor_completions.d/$binary_name.fish"
    
    install -dm755 "$pkgdir/etc/skel/.config/$binary_name"
}